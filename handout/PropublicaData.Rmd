---
title: "Exploring the ProPublica COMPAS data"
output:
  html_document:
      code_folding: hide
      df_print: paged
  pdf_document: default
---

# Loading and filtering data

```{r, warning=FALSE, error=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(grid)
library(gridExtra)
library(tidyverse)
```

After loading the raw data, we see the following number of rows:

```{r}
raw_data <- read.csv("~/My Drive/tex-documents/working-papers/algo-fairness/algo-fairness-m/rutgers-pres-algo/compas-scores-two-years.csv")
nrow(raw_data)
```

By filtering the data a bit, the number of rows becomes:

```{r}
df <- dplyr::select(raw_data, age, c_charge_degree, race, age_cat, score_text, sex, priors_count, 
                    days_b_screening_arrest, decile_score, is_recid, two_year_recid, c_jail_in, c_jail_out) %>% 
        filter(days_b_screening_arrest <= 30) %>%
        filter(days_b_screening_arrest >= -30) %>%
        filter(is_recid != -1) %>%
        filter(c_charge_degree != "O") %>%
        filter(score_text != 'N/A')
nrow(df)
```

## Race breakdown

The database is mostly constituted of blacks, whites and Hispanics. Asians and native-Americans are 
a small percentage. 


```{r}
race <- ggplot(df, aes(x=race)) + 
          # geom_histogram(aes(y=..count../sum(..count..)), colour="black", fill="grey100")  +                
          geom_bar(aes(y=..count../sum(..count..)), colour="black", fill="grey100") +
          xlab("race") + 
          ylab("frequency")
race
```



# Recidivism 

The recidivism rate is different across races. It is higher 
among blacks (almost 50\%), while it is comparably lower among whites and Hispanics (about 40\%) 
and even lower among Asians (about 25\%). 

Recidivism is defined as a rearrest for a criminal offense that occurred 
within two years after the COMPAS risk assessment took place. Arrest 
is therefore used as a proxy for criminal activity. 


```{r}
pblack <- ggplot(data=filter(df, race =="African-American"), aes(x=two_year_recid)) + 
          geom_histogram(aes(y=..count../sum(..count..)), binwidth = 1,  colour="black", fill="grey45")  +                           xlab("recidivism") + 
          ylab("frequency") + 
          ylim(0, 1) +
          scale_x_continuous(breaks = seq(0, 1, by = 1)) +
          theme(plot.title = element_text(hjust = 0.5)) + 
          theme(text=element_text(size = 15))

pwhite <- ggplot(data=filter(df, race =="Caucasian"), aes(x=two_year_recid)) + 
          geom_histogram(aes(y=..count../sum(..count..)), binwidth = 1,  colour="black", fill="grey100")  +                          xlab("recidivism") + 
          ylab("frequency") + 
          ylim(0, 1) +
          scale_x_continuous(breaks = seq(0, 1, by = 1)) +
          theme(plot.title = element_text(hjust = 0.5)) + 
          theme(text=element_text(size = 15))

phispanic <- ggplot(data=filter(df, race =="Hispanic"), aes(x=two_year_recid)) + 
          geom_histogram(aes(y=..count../sum(..count..)), binwidth = 1,  colour="black", fill="grey80")  +                           xlab("recidivism") + 
          ylab("frequency") + 
          ylim(0, 1) +
          scale_x_continuous(breaks = seq(0, 1, by = 1)) +
          theme(plot.title = element_text(hjust = 0.5)) + 
          theme(text=element_text(size = 15))

pasian <- ggplot(data=filter(df, race =="Asian"), aes(x=two_year_recid)) + 
          geom_histogram(aes(y=..count../sum(..count..)), binwidth = 1,  colour="black", fill="grey20")  +                           xlab("recidivism") + 
          ylab("frequency") + 
          ylim(0, 1) +
          scale_x_continuous(breaks = seq(0, 1, by = 1)) +
          theme(plot.title = element_text(hjust = 0.5)) + 
          theme(text=element_text(size = 15))

grid.arrange(pblack, pwhite, phispanic, pasian, ncol = 4, top=textGrob("Recidivism: Black, White, Hispanic, Asian", vjust= 0.4, gp=gpar(fontsize=25,font=4)))
```


# Risk scores distribution by race

COMPAS assigns each individual a score between 1 (very low risk of recidivism) 
and 10 (high risk of recidivism). We can plot the distribution of these scores 
by race. The scores of blacks are evenly distributed across all values from 1 to 10. 
The scores of Hispanics tend to be more concentrated towards lower values. 
This trend is even more apparent for whites. 


```{r, warning = FALSE}
pblack_s <- ggplot(data=filter(df, race =="African-American"), aes(x=decile_score)) + 
          geom_histogram(aes(y=..count../sum(..count..)), binwidth = 1,  colour="black", fill="grey45")  +                xlab("risk scores") + 
          ylab("frequency") + 
          ylim(0, 0.35) +
          ggtitle("Blacks") +
          scale_x_continuous(breaks = seq(0, 10, by = 1)) +
          theme(plot.title = element_text(hjust = 0.5)) + 
          theme(text=element_text(size = 15))

pwhite_s <- ggplot(data=filter(df, race =="Caucasian"), aes(x=decile_score)) + 
          geom_histogram(aes(y=..count../sum(..count..)), binwidth = 1,  colour="black", fill="grey100")  +                xlab("risk scores") + 
          ylab("frequency") + 
          ylim(0, 0.35) +
          ggtitle("Whites") +
          scale_x_continuous(breaks = seq(0, 10, by = 1)) +
          theme(plot.title = element_text(hjust = 0.5)) + 
          theme(text=element_text(size = 15))

phispanic_s <- ggplot(data=filter(df, race =="Hispanic"), aes(x=decile_score)) + 
          geom_histogram(aes(y=..count../sum(..count..)), binwidth = 1,  colour="black", fill="grey80")  +                           xlab("risk scores") + 
          ylab("frequency") + 
          ylim(0, 0.35) +
          ggtitle("Hispanics") +
          scale_x_continuous(breaks = seq(0, 10, by = 1)) +
          theme(plot.title = element_text(hjust = 0.5)) + 
          theme(text=element_text(size = 15))

grid.arrange(pblack_s, pwhite_s, phispanic_s, ncol = 3, top=textGrob("Scores overall", vjust= 0.4, gp=gpar(fontsize=25,font=4)))
```


# Risk scores distribution by race (non re-offenders only)

Let's focus on those individuals in the database for whom no criminal activity (i.e. arrest) 
was recorded within a period of two years. Call them non re-offenders. The distribution of the scores for these individuals should be different, mostly concentrated toward lower values. If they did not re-offend, COMPAS should have been able to predict that and assign them lower scores. This is the case for the three racial groups -- a sign that COMPAS is, to some extent, tracking future criminal behavior (i.e. arrest). However, the scores are more clearly concentrated towards lower values for whites and Hispanics, and much less clearly for blacks. 



```{r, echo=FALSE, cache=TRUE}

black_nrec <- subset(df, is_recid==0 & race =="African-American")

black_p_I <- ggplot(black_nrec) + aes(x=decile_score) +
          geom_histogram(aes(y=..count../sum(..count..)), binwidth = 1,  colour= "blue", fill="grey45") + 
          xlab("") + 
          ylab("frequency") + 
          ylim(0, 0.4) + 
          ggtitle("Blacks") +
          scale_x_continuous(breaks = seq(1, 10, by = 1)) +
          theme(plot.title = element_text(hjust = 0.5)) + 
          theme(text=element_text(size = 15))  +
          geom_vline(xintercept = 4.5, linetype="dashed", color = "black", size=0.5)

white_nrec <- subset(df, is_recid==0 & race =="Caucasian")

white_p_I <- ggplot(white_nrec) + aes(x=decile_score) +
          geom_histogram(aes(y=..count../sum(..count..)), binwidth = 1,  colour="blue", fill="grey100") + 
          xlab("") + 
          ylab("frequency") + 
          ylim(0, 0.4) + 
          ggtitle("Whites") +
          scale_x_continuous(breaks = seq(1, 10, by = 1)) +
          theme(plot.title = element_text(hjust = 0.5)) + 
          theme(text=element_text(size = 15)) +
          geom_vline(xintercept = 4.5, linetype="dashed", color = "black", size=0.5)

hispanic_nrec <- subset(df, is_recid==0 & race =="Hispanic")

hispanic_p_I <- ggplot(hispanic_nrec) + aes(x=decile_score) +
          geom_histogram(aes(y=..count../sum(..count..)), binwidth = 1,  colour="blue", fill="grey80") + 
          xlab("") + 
          ylab("frequency") + 
          ylim(0, 0.4) + 
          ggtitle("Hispanics") +
          scale_x_continuous(breaks = seq(1, 10, by = 1)) +
          theme(plot.title = element_text(hjust = 0.5)) + 
          theme(text=element_text(size = 15)) +
          geom_vline(xintercept = 4.5, linetype="dashed", color = "black", size=0.5)

grid.arrange(black_p_I, white_p_I, hispanic_p_I, ncol = 3, top=textGrob("Scores for non re-offenders", vjust= 0.4, gp=gpar(fontsize=25,font=4)))

```

# Risk scores distribution by race (re-offenders only)

Let's focus on those individuals in the database for whom criminal activity (i.e. arrest) 
was recorded within a period of two years. Call them re-offenders. The distribution of the scores for these individuals should be concentrated toward higher values. If they did re-offend, COMPAS should have been able to predict that and assign them higher scores. This is the case for blacks, but not for whites and Hispanics --  a sign that COMPAS is, to some extent, tracking future criminal behavior (i.e. arrest) for blacks, but much less so for whites and Hispanics. 


```{r, echo=FALSE, cache=TRUE}

black_rec <- subset(df, is_recid==1 & race =="African-American")

black_p_G <- ggplot(black_rec) + aes(x=decile_score) +
          geom_histogram(aes(y=..count../sum(..count..)), binwidth = 1,  colour="red", fill="grey45") + 
          xlab("") + 
          ylab("") + 
          ylim(0, 0.4) + 
          ggtitle("Blacks") +
          scale_x_continuous(breaks = seq(1, 10, by = 1)) +
          theme(plot.title = element_text(hjust = 0.5)) + 
          theme(text=element_text(size = 15)) +
          geom_vline(xintercept = 4.5, linetype="dashed", color = "black", size=0.5)

white_rec <- subset(df, is_recid==1 & race =="Caucasian")

white_p_G <- ggplot(white_rec) + aes(x=decile_score) +
          geom_histogram(aes(y=..count../sum(..count..)), binwidth = 1,  colour="red", fill="grey100") + 
          xlab("") + 
          ylab("") + 
          ylim(0, 0.4) + 
          ggtitle("Whites") +
          scale_x_continuous(breaks = seq(1, 10, by = 1)) +
          theme(plot.title = element_text(hjust = 0.5)) + 
          theme(text=element_text(size = 15)) +
          geom_vline(xintercept = 4.5, linetype="dashed", color = "black", size=0.5)

hispanic_rec <- subset(df, is_recid==1 & race =="Hispanic")

hispanic_p_G <- ggplot(hispanic_rec) + aes(x=decile_score) +
          geom_histogram(aes(y=..count../sum(..count..)), binwidth = 1,  colour="red", fill="grey80") + 
          xlab("") + 
          ylab("") + 
          ylim(0, 0.4) + 
          ggtitle("Hispanics") +
          scale_x_continuous(breaks = seq(1, 10, by = 1)) +
          theme(plot.title = element_text(hjust = 0.5)) + 
          theme(text=element_text(size = 15)) +
          geom_vline(xintercept = 4.5, linetype="dashed", color = "black", size=0.5)

grid.arrange(black_p_G, white_p_G, hispanic_p_G, ncol = 3, top=textGrob("Scores for re-offenders", vjust= 0.4, gp=gpar(fontsize=25,font=4))) 


```

# Racial Disparities in false positives classification

The false positives rates is higher for blacks compared to whites and Hispanics. 
COMPAS does not return a yes/no decision, but simply a risk score between 1 and 10. 
We can force a yes/no decision by stipulating that anyone with a score of at least 
5 is classified as a re-offenders by COMPAS. So, a false positive occurs when someone who is not a re-offenders is classified as such by COMPAS. The false positive classification rate is defined as the following fraction:
$\frac{\# [\text{ individual is classified as reoffender but is not}]}{\# [\text{ individual is not a re-offender}]}$.

This is the conditional probability $Pr(\text{ individual is classified as reoffender} \textit{ given that } \text{individual is not a reoffender})$.

The false positive classification rate is 41\% for blacks, 21\% for whites and 18\% for Hispanics. 
There is a significant difference between blacks, on one hand, and whites and Hispanics on the other hand.
The disparity does not go away if the threshold is increased to at least 7 instead of 5. 
The false positive classification rate becomes 21\% for blacks, 8\% for whites and 10\% for Hispanics. 



```{r}
black_I <- subset(df, race =="African-American" & is_recid==0)
black_I_Cg <- subset(df, race =="African-American" & is_recid==0 & decile_score>4)

fp_black <- nrow(black_I_Cg)/nrow(black_I)

print(paste0("Compas false positive rate for blacks: ", fp_black))

white_I <- subset(df, race =="Caucasian" & is_recid==0)
white_I_Cg <- subset(df, race =="Caucasian" & is_recid==0 & decile_score>4)

fp_white <- nrow(white_I_Cg)/nrow(white_I)

print(paste0("Compas false positive rate for Whites: ", fp_white))

hispanic_I <- subset(df, race =="Hispanic" & is_recid==0)
hispanic_I_Cg <- subset(df, race =="Hispanic" & is_recid==0 & decile_score>4)

fp_hispanic <- nrow(hispanic_I_Cg)/nrow(hispanic_I)

print(paste0("Compas false positive rate for Hispanics: ", fp_hispanic))

black_I <- subset(df, race =="African-American" & is_recid==0)
black_I_Cg <- subset(df, race =="African-American" & is_recid==0 & decile_score>6)

fp_black <- nrow(black_I_Cg)/nrow(black_I)

print(paste0("Compas false positive rate for blacks (>6): ", fp_black))

white_I <- subset(df, race =="Caucasian" & is_recid==0)
white_I_Cg <- subset(df, race =="Caucasian" & is_recid==0 & decile_score>6)

fp_white <- nrow(white_I_Cg)/nrow(white_I)

print(paste0("Compas false positive rate for Whites (>6): ", fp_white))

hispanic_I <- subset(df, race =="Hispanic" & is_recid==0)
hispanic_I_Cg <- subset(df, race =="Hispanic" & is_recid==0 & decile_score>6)

fp_hispanic <- nrow(hispanic_I_Cg)/nrow(hispanic_I)

print(paste0("Compas false positive rate for Hispanics (>6): ", fp_hispanic))
```


# Age

One might think that the disparity is attributable to age differences 
between races. Blacks tend to be younger than whites and Hispanics. Yonger people tend to commit more crime. 
The score distributions for blacks and whites become more similar if we compare individual of the same age, say younger than 25. The disparities in false positive classification rate shrink significantly (though does not disappear entirely) if we compares whites and blacks of the same age group, say younger than 25. Interestingly, the false positive classification rates goes up significantly for both groups, to 60\% for young blacks and 48\% for young whites. 



```{r}
black_age <- ggplot(data=filter(df, race =="African-American"), aes(x=age_cat)) + 
          # geom_histogram(aes(y=..count../sum(..count..)), colour="black", fill="grey45")  +                
          geom_bar(aes(y=..count../sum(..count..)), colour="black", fill="grey45") +
          xlab("age") + 
          ylab("frequency") + 
          ylim(0, 1) +
          theme(plot.title = element_text(hjust = 0.5)) + 
          theme(text=element_text(size = 20)) +
          theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
          scale_x_discrete(limits = c("Less than 25", "25 - 45", "Greater than 45"))

white_age <- ggplot(data=filter(df, race =="Caucasian"), aes(x=age_cat)) + 
          # geom_histogram(aes(y=..count../sum(..count..)), colour="black", fill="grey100")  +                
          geom_bar(aes(y=..count../sum(..count..)), colour="black", fill="grey100") +
          xlab("age") + 
          ylab("frequency") + 
          ylim(0, 1) + 
          theme(plot.title = element_text(hjust = 0.5)) + 
          theme(text=element_text(size = 20)) +
          theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
          scale_x_discrete(limits = c("Less than 25", "25 - 45", "Greater than 45"))

hispanic_age <- ggplot(data=filter(df, race =="Hispanic"), aes(x=age_cat)) + 
          # geom_histogram(aes(y=..count../sum(..count..)), colour="black", fill="grey80")  +                
          geom_bar(aes(y=..count../sum(..count..)), colour="black", fill="grey100") +
          xlab("age") + 
          ylab("frequency") + 
          ylim(0, 1) + 
          theme(plot.title = element_text(hjust = 0.5)) + 
          theme(text=element_text(size = 20)) +
          theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
          scale_x_discrete(limits = c("Less than 25", "25 - 45", "Greater than 45"))

grid.arrange(black_age, white_age, hispanic_age, ncol = 3, top=textGrob("Age: Black, White, Hispanic", vjust= 0.4, gp=gpar(fontsize=25,font=4))) 
```
```{r, echo=FALSE, cache=TRUE}

white_young_nrec <- subset(df, is_recid==0 & age_cat =="Less than 25" & race =="Caucasian")

white_young_p_I <- ggplot(white_young_nrec) + aes(x=decile_score) +
          geom_histogram(aes(y=..count../sum(..count..)), binwidth = 1,  colour= "blue", fill="grey100") + 
          xlab("") + 
          ylab("frequency") + 
          ylim(0, 0.4) + 
          ggtitle("White and < 25") +
          scale_x_continuous(breaks = seq(1, 10, by = 1)) +
          theme(plot.title = element_text(hjust = 0.5)) + 
          theme(text=element_text(size = 22))  +
          geom_vline(xintercept = 4.5, linetype="dashed", color = "black", size=0.5)

black_young_nrec <- subset(df, is_recid==0 & age_cat =="Less than 25" & race =="African-American")

black_young_p_I <- ggplot(black_young_nrec) + aes(x=decile_score) +
          geom_histogram(aes(y=..count../sum(..count..)), binwidth = 1,  colour= "blue", fill="grey45") + 
          xlab("") + 
          ylab("frequency") + 
          ylim(0, 0.4) + 
          ggtitle("Black and <  25") +
          scale_x_continuous(breaks = seq(1, 10, by = 1)) +
          theme(plot.title = element_text(hjust = 0.5)) + 
          theme(text=element_text(size = 22))  +
          geom_vline(xintercept = 4.5, linetype="dashed", color = "black", size=0.5)

grid.arrange(white_young_p_I, black_young_p_I, ncol = 2, top=textGrob("Non-reoffenders: Scores by Race and Age", vjust= 0.4, gp=gpar(fontsize=25,font=4)))

```

```{r, echo=FALSE, cache=TRUE}

white_young_rec <- subset(df, is_recid==1 & age_cat =="Less than 25" & race =="Caucasian")

white_young_p_G <- ggplot(white_young_rec) + aes(x=decile_score) +
          geom_histogram(aes(y=..count../sum(..count..)), binwidth = 1,  colour= "red", fill="grey100") + 
          xlab("") + 
          ylab("frequency") + 
          ylim(0, 0.4) + 
          ggtitle("White and < 25") +
          scale_x_continuous(breaks = seq(1, 10, by = 1)) +
          theme(plot.title = element_text(hjust = 0.5)) + 
          theme(text=element_text(size = 22))  +
          geom_vline(xintercept = 4.5, linetype="dashed", color = "black", size=0.5)

black_young_rec <- subset(df, is_recid==1 & age_cat =="Less than 25" & race =="African-American")

black_young_p_G <- ggplot(black_young_rec) + aes(x=decile_score) +
          geom_histogram(aes(y=..count../sum(..count..)), binwidth = 1,  colour= "red", fill="grey45") + 
          xlab("") + 
          ylab("frequency") + 
          ylim(0, 0.4) + 
          ggtitle("Black and <  25") +
          scale_x_continuous(breaks = seq(1, 10, by = 1)) +
          theme(plot.title = element_text(hjust = 0.5)) + 
          theme(text=element_text(size = 22))  +
          geom_vline(xintercept = 4.5, linetype="dashed", color = "black", size=0.5)

grid.arrange(white_young_p_G, black_young_p_G, ncol = 2, top=textGrob("Reoffenders: Scores by Race and Age", vjust= 0.4, gp=gpar(fontsize=25,font=4)))
```



```{r}
black_young_I <- subset(df, race =="African-American" & is_recid==0 & age_cat=="Less than 25")
black_young_I_Cg <- subset(df, race =="African-American" & is_recid==0 & decile_score>4 & age_cat=="Less than 25")

nrow(black_young_I)
nrow(black_young_I_Cg)

fp_young_black <- nrow(black_young_I_Cg)/nrow(black_young_I)

print(paste0("COMPAS false positive rate for blacks (< 25): ", fp_young_black))

white_young_I <- subset(df, race =="Caucasian" & is_recid==0 & age_cat=="Less than 25")
white_young_I_Cg <- subset(df, race =="Caucasian" & is_recid==0 & decile_score>4 & age_cat=="Less than 25")

nrow(white_young_I)
nrow(white_young_I_Cg)

fp_young_white <- nrow(white_young_I_Cg)/nrow(white_young_I)

print(paste0("COMPAS false positive rate for whites (< 25): ", fp_young_white))
```

